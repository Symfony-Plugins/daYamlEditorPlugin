<?php
/**
 * Handle daYamlEditor.yml config file
 * @author dalexandre
 */
class daYamlEditorConfigHandler extends sfYamlConfigHandler
{
  /**
   * Executes this configuration handler.
   *
   * @param array $configFiles An array of absolute filesystem path to a configuration file
   *
   * @return string Data to be written to a cache file
   */
  public function execute($configFiles)
  {
    $config = self::getConfiguration($configFiles);

    // Check if fields name are not declared twice
    $already_used = array();
    foreach ($config as $block)
    {
      foreach ($block['fields'] as $name => $options)
      {
        if (in_array($name, $already_used)) throw new sfParseException("Field names must be unique even in separate blocks");
        $already_used[] = $name;
      }
    }

    // compile data
    $retval = "<?php\n".
              "// auto-generated by %s\n".
              "// see daYamlEditorPlugin\n".
              "// date: %s\nreturn %s;\n";
    $retval = sprintf($retval, __CLASS__, date('Y/m/d H:i:s'), var_export($config, true));

    return $retval;
  }

  /**
   * @see sfConfigHandler
   */
  static public function getConfiguration(array $configFiles)
  {
    $config = self::parseYamls($configFiles);

    return self::replaceConstants(self::flattenConfigurationWithEnvironment($config));
  }
}
